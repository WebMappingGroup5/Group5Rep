<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cave Dwellers Map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>

    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.0/dist/leaflet-routing-machine.css"/>

    <!-- Geocoder CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>

    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Header -->
    <div id="header">
        <h1>Cave Dwellers</h1>
        <h2>Directions</h2>
    </div>

    <!-- Sidebar -->
    <div id="sidebar">
        <a class="icon" href="finalproject.html">
            <img src=".git/Images/silhouette-black-bat-transparent-1753599158YEa.jpg" class="icon">
        </a>
        <a class="side-btn" href="querypage.html">Filter Caves by Attribute</a>
        <a class="side-btn" href="directions.html">Directions</a>
        <a class="side-btn" href="aboutus.html">About Us</a>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Address Search Box -->
    <input id="searchBox" type="text" placeholder="Search for an address...">

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.0/dist/leaflet-routing-machine.js"></script>

    <!-- Geocoder JS -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <script>

      /* -------------------------
         MAP INITIALIZATION
      -------------------------- */
      var map = L.map('map').setView([30.20, -98.987], 8.7);

      L.tileLayer('https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', {
          maxZoom: 19
      }).addTo(map);

      const allLocations = [];
      let routeControl = null;
      let selectedCavePoint = null;   // route end point
      let searchStartPoint = null;    // route start point (address)


      /* -------------------------
         LOAD CSV MARKERS
      -------------------------- */
      function loadCsv(url) {
        Papa.parse(url, {
          download: true,
          header: false,
          complete: function(results) {
            results.data.forEach(row => {
              if (row.length < 5) return;

              const lon = parseFloat(row[3]);
              const lat = parseFloat(row[4]);
              if (isNaN(lat) || isNaN(lon)) return;

              const name = row[1] || "Unknown Cave";
              const link = row[2];

              let popupHtml = `<strong>${name}</strong><br>`;
              if (link) popupHtml += `<a href="${link}" target="_blank">Website</a><br>`;
              popupHtml += `Lat: ${lat}, Lon: ${lon}`;

              const marker = L.marker([lat, lon]).addTo(map).bindPopup(popupHtml);

              marker.on("click", () => {
                selectedCavePoint = L.latLng(lat, lon);
                if (searchStartPoint) {
                  buildRoute();
                } else {
                  alert("Now search an address to route from.");
                }
              });

              allLocations.push({marker, name, link, lat, lon});
            });
          }
        });
      }

      const csvFiles = ["wonder.csv","longhorn.csv","cascade.csv","noname.csv","sonora.csv","space.csv","bridge.csv"];
      csvFiles.forEach(loadCsv);



      /* -------------------------
         ADDRESS SEARCH (Nominatim)
      -------------------------- */
      async function geocodeAddress(query) {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`;
        const res = await fetch(url);
        const data = await res.json();
        if (!data.length) return null;

        return {
          lat: parseFloat(data[0].lat),
          lon: parseFloat(data[0].lon),
          label: data[0].display_name
        };
      }

      document.getElementById("searchBox").addEventListener("keydown", async function(e) {
        if (e.key === "Enter") {
          const query = this.value.trim();
          if (!query) return;

          const result = await geocodeAddress(query);
          if (!result) {
            alert("Address not found!");
            return;
          }

          searchStartPoint = L.latLng(result.lat, result.lon);

          L.marker(searchStartPoint)
            .addTo(map)
            .bindPopup(result.label)
            .openPopup();

          map.setView(searchStartPoint, 12);

          if (selectedCavePoint) buildRoute();
        }
      });


      /* -------------------------
         ROUTING FUNCTION
      -------------------------- */
function buildRoute() {
    if (!searchStartPoint || !selectedCavePoint) return;

    if (routeControl) map.removeControl(routeControl);

    routeControl = L.Routing.control({
        waypoints: [
            searchStartPoint,
            selectedCavePoint
        ],
        lineOptions: { addWaypoints: false },
        createMarker: () => null,
        position: 'bottomleft'
    }).addTo(map);

    // Move routing panel above search box
    setTimeout(() => {
        const controlContainer = routeControl.getContainer();
        if (!controlContainer) return;

        // 20px above bottom + 20px offset from search box
        controlContainer.style.marginBottom = '40px';
    }, 100);
}
    </script>

</body>
</html>